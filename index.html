<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Dashboard - Laporan Office Cabang</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root { --glass-border: 1px solid rgba(255, 255, 255, 0.2); --glass-bg: rgba(255, 255, 255, 0.95); }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f0f4f8; color: #1e293b; }
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.6); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .glass-nav { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .bg-gradient-primary { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); }
        #loadingOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body class="antialiased">

    <!-- Loading State -->
    <div id="loadingOverlay">
        <div class="relative mb-4">
            <div class="w-20 h-20 border-4 border-slate-100 border-t-blue-600 rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center"><i class="fa-solid fa-bolt text-blue-600 text-xl animate-pulse"></i></div>
        </div>
        <p class="font-bold text-slate-600 tracking-widest text-xs uppercase">Sinkronisasi Data...</p>
    </div>

    <!-- Navbar -->
    <nav class="glass-nav fixed w-full top-0 z-50 text-white py-3">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 p-2 rounded-xl"><i class="fa-solid fa-chart-pie"></i></div>
                <div class="leading-none">
                    <span class="block text-[10px] font-bold text-blue-300 uppercase">Executive Dashboard</span>
                    <span class="block text-lg font-bold" id="navBranchName">Multi Wilayah</span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="window.print()" class="bg-white text-slate-900 px-4 py-2 rounded-lg text-xs font-bold shadow-lg">
                    <i class="fa-solid fa-print mr-1"></i> Export PDF
                </button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 pt-32 pb-12">
        <!-- Stats Card -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
            <div class="glass-panel p-6 rounded-2xl">
                <p class="text-xs font-bold text-slate-400 uppercase mb-2">Total Sales</p>
                <h3 class="text-2xl font-extrabold text-slate-800" id="totalRevenue">Rp 0</h3>
            </div>
            <div class="glass-panel p-6 rounded-2xl">
                <p class="text-xs font-bold text-slate-400 uppercase mb-2">Barang Keluar</p>
                <h3 class="text-2xl font-extrabold text-slate-800" id="totalSoldCrt">0 Crt</h3>
            </div>
            <div class="glass-panel p-6 rounded-2xl">
                <p class="text-xs font-bold text-slate-400 uppercase mb-2">Barang Masuk</p>
                <h3 class="text-2xl font-extrabold text-slate-800" id="totalInboundCrt">0 Crt</h3>
            </div>
            <div class="bg-gradient-primary text-white p-6 rounded-2xl shadow-xl shadow-blue-500/20">
                <p class="text-xs font-bold text-blue-200 uppercase mb-2">Stok Akhir</p>
                <h3 class="text-3xl font-extrabold" id="realStockDisplay">0</h3>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-12">
            <div class="lg:col-span-2 glass-panel p-6 rounded-2xl">
                <h4 class="font-bold text-slate-700 mb-4 text-sm uppercase">Tren Penjualan</h4>
                <div class="h-64"><canvas id="salesTrendChart"></canvas></div>
            </div>
            <div class="glass-panel p-6 rounded-2xl">
                <h4 class="font-bold text-slate-700 mb-4 text-sm uppercase text-center">Brand</h4>
                <div class="h-48 flex justify-center"><canvas id="brandPieChart"></canvas></div>
                <div id="brandSummary" class="mt-4 grid grid-cols-2 gap-2 text-[10px] text-center"></div>
            </div>
        </div>

        <div class="glass-panel rounded-2xl overflow-hidden shadow-lg">
            <div class="bg-slate-900 text-white px-6 py-4 flex justify-between items-center font-bold text-sm">
                Detail Stok Gudang
            </div>
            <div class="overflow-x-auto max-h-96 bg-white">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-50 text-slate-500 font-bold uppercase text-[10px] sticky top-0">
                        <tr>
                            <th class="p-4">Wilayah</th>
                            <th class="p-4">Produk</th>
                            <th class="p-4 text-right">Masuk</th>
                            <th class="p-4 text-right">Keluar</th>
                            <th class="p-4 text-right">Sisa</th>
                        </tr>
                    </thead>
                    <tbody id="stockTableBody" class="divide-y divide-slate-100 text-xs"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        /**
         * TEMPELKAN URL WEB APP GOOGLE SCRIPT ANDA DI SINI
         * Contoh: https://script.google.com/macros/s/AKfycb.../exec
         */
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzc4PQkNuA-DLM6hK2xf9KiJG8Lzs3hgOd6zm36I_ecbOY64kVSLlkTVos3njbzQu0qNg/exec";

        let rawData = {};
        let charts = {};
        const fRupiah = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n || 0);
        const fNum = (n) => new Intl.NumberFormat('id-ID').format(n || 0);

        document.addEventListener('DOMContentLoaded', initApp);

        function initApp() {
            if (!GAS_API_URL || GAS_API_URL.includes("TEMPEL_URL")) {
                document.getElementById('loadingOverlay').innerHTML = `
                    <div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-sm">
                        <i class="fa-solid fa-circle-exclamation text-red-500 text-4xl mb-4"></i>
                        <h2 class="font-bold text-slate-800">URL Belum Diset!</h2>
                        <p class="text-xs text-slate-500 mt-2 leading-relaxed">Silakan buka file index.html dan tempelkan link Apps Script Anda pada variabel GAS_API_URL di baris 112.</p>
                    </div>
                `;
                return;
            }
            fetchData(GAS_API_URL);
        }

        async function fetchData(apiUrl) {
            try {
                // Menambahkan parameter ?action=getData agar Apps Script mengirim JSON
                const response = await fetch(`${apiUrl}?action=getData`);
                if (!response.ok) throw new Error("Gagal mengambil data dari server.");
                
                const data = await response.json();
                
                if (data.error) throw new Error(data.details || "Error pada Apps Script.");
                
                rawData = data;
                document.getElementById('loadingOverlay').classList.add('hidden');
                updateUI(data.sales || [], data.inbound || [], data.stock || []);
            } catch (err) {
                console.error(err);
                document.getElementById('loadingOverlay').innerHTML = `
                    <div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-sm">
                        <i class="fa-solid fa-triangle-exclamation text-orange-500 text-4xl mb-4"></i>
                        <h2 class="font-bold text-slate-800">Gagal Memuat Data</h2>
                        <p class="text-xs text-slate-500 mt-2 mb-4 leading-relaxed">${err.message}</p>
                        <button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-lg">Coba Lagi</button>
                    </div>
                `;
            }
        }

        function updateUI(sales, inbound, stock) {
            document.getElementById('totalRevenue').innerText = fRupiah(sales.reduce((a,b)=>a+(parseFloat(b.amount)||0),0));
            document.getElementById('totalSoldCrt').innerText = fNum(sales.reduce((a,b)=>a+(parseInt(b.crt)||0),0)) + " Crt";
            document.getElementById('totalInboundCrt').innerText = fNum(inbound.reduce((a,b)=>a+(parseInt(b.crt)||0),0)) + " Crt";
            document.getElementById('realStockDisplay').innerText = fNum(stock.reduce((a,b)=>a+(parseInt(b.crt)||0),0));

            document.getElementById('stockTableBody').innerHTML = stock.map(s=>`
                <tr class="hover:bg-blue-50/50 border-b border-slate-50">
                    <td class="p-4 font-bold text-slate-700">${s.area || '-'}</td>
                    <td class="p-4 text-slate-600">${s.item || '-'}</td>
                    <td class="p-4 text-right text-emerald-600 font-bold">+${fNum(s.inbound_sum)}</td>
                    <td class="p-4 text-right text-orange-600 font-bold">-${fNum(s.sales_sum)}</td>
                    <td class="p-4 text-right font-extrabold text-blue-700">${fNum(s.crt)}</td>
                </tr>`).join('');

            renderCharts(sales);
        }

        function renderCharts(sales) {
            // Trend Chart
            const trend = {};
            sales.forEach(s => trend[s.date] = (trend[s.date]||0) + parseFloat(s.amount));
            const ctxLine = document.getElementById('salesTrendChart').getContext('2d');
            if(charts.line) charts.line.destroy();
            charts.line = new Chart(ctxLine, {
                type: 'line',
                data: { 
                    labels: Object.keys(trend), 
                    datasets: [{ 
                        data: Object.values(trend), 
                        borderColor: '#2563eb', 
                        tension: 0.3, 
                        fill: true, 
                        backgroundColor: 'rgba(37,99,235,0.05)',
                        pointRadius: 4,
                        pointBackgroundColor: '#2563eb'
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Brand Chart
            const brands = {};
            sales.forEach(s => {
                let b = 'Other';
                const n = (s.item||'').toLowerCase();
                if(n.includes('diamond')) b='Diamond'; else if(n.includes('ultra')) b='Ultra'; else if(n.includes('cimory')) b='Cimory';
                brands[b] = (brands[b]||0) + parseInt(s.crt||0);
            });
            const ctxPie = document.getElementById('brandPieChart').getContext('2d');
            if(charts.pie) charts.pie.destroy();
            charts.pie = new Chart(ctxPie, {
                type: 'doughnut',
                data: { 
                    labels: Object.keys(brands), 
                    datasets: [{ 
                        data: Object.values(brands), 
                        backgroundColor: ['#ef4444','#3b82f6','#ec4899','#cbd5e1'],
                        borderWidth: 0
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } }
                }
            });
            document.getElementById('brandSummary').innerHTML = Object.entries(brands).map(([k,v])=>`
                <div class="bg-slate-50 p-2 rounded-lg">
                    <p class="text-slate-400 uppercase font-bold text-[8px]">${k}</p>
                    <p class="font-extrabold text-slate-700">${fNum(v)}</p>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
